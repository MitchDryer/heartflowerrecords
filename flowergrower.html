<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mobile Audio Test</title>
<style>
  html, body {
    margin: 0; padding: 0; overflow: hidden;
    font-family: Arial, sans-serif;
    background: #222;
    color: white;
    user-select: none;
  }
  #start-audio, #test-tone {
    position: fixed;
    left: 10px;
    padding: 10px 15px;
    font-size: 16px;
    cursor: pointer;
    z-index: 1000;
  }
  #start-audio { top: 10px; }
  #test-tone { top: 60px; }
  canvas {
    display: block;
    background: #444;
  }
</style>
</head>
<body>

<button id="start-audio">Start Audio</button>
<button id="test-tone">Test Tone</button>
<canvas id="canvas"></canvas>

<script>
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');

  let W = window.innerWidth;
  let H = window.innerHeight;
  canvas.width = W;
  canvas.height = H;

  const rect = { x: W/2 - 110, y: H/2 - 150, w: 220, h: 300 };

  let audioCtx = null;

  const DOT_COLORS = ["red", "lime", "blue", "yellow", "magenta", "cyan"];

  // Simple note play function
  function playNote(freq, duration = 0.2) {
    if (!audioCtx) return;

    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.frequency.value = freq;
    osc.type = "sine";

    const now = audioCtx.currentTime;
    gain.gain.setValueAtTime(0, now);
    gain.gain.linearRampToValueAtTime(0.2, now + 0.01);
    gain.gain.linearRampToValueAtTime(0, now + duration);

    osc.connect(gain).connect(audioCtx.destination);
    osc.start(now);
    osc.stop(now + duration + 0.05);
  }

  // Start Audio button unlocks audio context
  const startBtn = document.getElementById('start-audio');
  startBtn.addEventListener('click', () => {
    if (!audioCtx) {
      const AudioContext = window.AudioContext || window.webkitAudioContext;
      audioCtx = new AudioContext();
    }
    if (audioCtx.state === 'suspended') {
      audioCtx.resume().then(() => {
        console.log('AudioContext resumed');
        startBtn.style.display = 'none';
      });
    } else {
      startBtn.style.display = 'none';
    }
  });

  // Test Tone button plays a beep
  document.getElementById('test-tone').addEventListener('click', () => {
    if (!audioCtx) {
      const AudioContext = window.AudioContext || window.webkitAudioContext;
      audioCtx = new AudioContext();
    }
    if (audioCtx.state === 'suspended') {
      audioCtx.resume().then(() => playNote(440));
    } else {
      playNote(440);
    }
  });

  // Dummy sequence: play 5 notes going up in frequency
  function startSequence(x, y) {
    if (!audioCtx) return;

    const baseFreq = 220;
    const interval = 2; // semitones

    for (let i = 0; i < 5; i++) {
      const freq = baseFreq * Math.pow(2, (interval * i) / 12);
      setTimeout(() => playNote(freq), i * 300);
    }
  }

  // Canvas interaction for desktop and mobile
  canvas.addEventListener('click', (e) => {
    if (
      e.clientX > rect.x &&
      e.clientX < rect.x + rect.w &&
      e.clientY > rect.y &&
      e.clientY < rect.y + rect.h
    ) {
      if (!audioCtx) {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        audioCtx = new AudioContext();
      }
      if (audioCtx.state === 'suspended') {
        audioCtx.resume().then(() => startSequence(e.clientX, e.clientY));
      } else {
        startSequence(e.clientX, e.clientY);
      }
    }
  });

  canvas.addEventListener('touchstart', (e) => {
    e.preventDefault();
    const touch = e.touches[0];
    if (
      touch.clientX > rect.x &&
      touch.clientX < rect.x + rect.w &&
      touch.clientY > rect.y &&
      touch.clientY < rect.y + rect.h
    ) {
      if (!audioCtx) {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        audioCtx = new AudioContext();
      }
      if (audioCtx.state === 'suspended') {
        audioCtx.resume().then(() => startSequence(touch.clientX, touch.clientY));
      } else {
        startSequence(touch.clientX, touch.clientY);
      }
    }
  }, { passive: false });

  // Draw rectangle on canvas
  function draw() {
    ctx.clearRect(0, 0, W, H);
    ctx.fillStyle = "saddlebrown";
    ctx.fillRect(rect.x, rect.y, rect.w, rect.h);

    requestAnimationFrame(draw);
  }
  draw();

  // Resize handling
  window.addEventListener('resize', () => {
    W = window.innerWidth;
    H = window.innerHeight;
    canvas.width = W;
    canvas.height = H;
    rect.x = W / 2 - 110;
    rect.y = H / 2 - 150;
  });
</script>

</body>
</html>
